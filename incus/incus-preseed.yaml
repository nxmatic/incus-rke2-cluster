# incus preseed for rke2 cluster (dual NIC via macvlan) (@codebase)
#
# Refactor Note:
# Previously, lan0 and wan0 were attached to Incus-managed bridges (e.g., rke2-<node>-lan-br),
# which provided DHCP/DNS via Incus (dnsmasq). This approach failed due to Linux bridge constraints:
# "Only unconfigured network interfaces can be bridged"â€”host interfaces were already configured.
#
# Now, lan0 and wan0 are attached as macvlan (vlan) devices directly to host interfaces (vmlan0, vmwan0).
# This means:
#   - Each Incus instance gets its own lan0/wan0 NIC, isolated at L2, but directly on the host's network segment.
#   - No Incus bridge or managed network is created; vmlan0/vmwan0 are physical, unmanaged Incus networks.
#   - DHCP/DNS must be provided by an external server on those networks, or by running a DHCP server
#     (e.g., dnsmasq) on the host.
#   - The Incus instance cannot communicate with the host via macvlan parent (by design), only with other devices on
#     the same L2 segment.
#
# This approach enables deterministic, per-node interface naming (lan0/wan0) and avoids bridge name length issues.
# However, it requires external DHCP or static IP assignment for connectivity.
config: {}
storage_pools:
  - name: default
    driver: zfs
    config:
      source: tank/nerd/incus
networks: []  # no Incus-managed bridges; macvlan attachments only
profiles:
  - name: ${RKE2_NODE_PROFILE_NAME}
    description: RKE2 profile (mode=${NETWORK_MODE}, dual-NIC macvlan)
    devices:
      root:
        path: /
        pool: default
        type: disk
      lan0:
        name: lan0
        nictype: macvlan
        parent: vmlan0
        type: nic
      wan0:
        name: wan0
        nictype: macvlan
        parent: vmwan0
        type: nic
