#!/usr/bin/env -S bash -euo pipefail

exec 2>/tmp/derive-network-setters.log
set -x

input=$(cat)

: "Load setter values from existing ConfigMaps in input"
set -a
source <( yq -o shell '
  select(.kind == "ConfigMap" and 
         .metadata.annotations."internal.kpt.dev/function-config" == "apply-setters") |
  .data
' - <<< "$input" )
set +a

: "Locate precomputed plan (generated by make.d/network/rules.mk)"
basedir="$(dirname "$0")/../.."
netplan="${basedir}/network.yaml"
if [[ ! -f "$netplan" ]]; then
  netplan="${basedir}/rke2-subtree/bioskop/network.yaml"
fi
if [[ ! -f "$netplan" ]]; then
  echo "network.yaml not found at $netplan; run make generate@network" >&2
  exit 1
fi
set -a
source <( yq -o shell '.data' "$netplan")
set +a

: "Patch helm chart values from the loaded values in the environment"
# Substitute ${...} placeholders in HelmChart/HelmChartConfig valuesContent using envsubst
yq eval '
  with(.items[] | select(.kind == "HelmChart" or .kind == "HelmChartConfig");
    .spec.valuesContent |= envsubst
  )
' - <<< "$input"