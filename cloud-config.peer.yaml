# Peer1 control plane node specific configuration

name: peer1-control-node

write_files:
  # =============================================================================
  # PEER1 NODE SPECIFIC CONFIGURATION
  # =============================================================================

  # ETCD configuration for peer1 node
  - path: /etc/rancher/rke2/config.yaml.d/etcd.yaml
    content: |
      etcd-expose-metrics: true
      node-name: peer1-control-node
      with-node-id: false

  # Dedicated server fragment (templated -> rendered server.yaml)
  - path: /etc/rancher/rke2/config.yaml.d/server.yaml
    content: |
      # NOTE:
      # Port 9345 is the RKE2 supervisor (bootstrap) port used by joining server nodes.
      # The control-plane VIP (${CLUSTER_INET_VIRTUAL}) is only advertising the Kubernetes
      # API server on 6443 via the Service load balancer and does NOT forward 9345.
      # Therefore peers must talk directly to an existing server node (the initial master)
      # on its node IP for the 9345 endpoint. Keep using the VIP only for kubectl / API (6443).
      server: https://${CLUSTER_INET_MASTER}:9345

  # VIP routing configuration for peer nodes to access master's VIP
  - path: /etc/systemd/system/configure-vip-routing.service
    content: |
      [Unit]
      Description=Configure VIP routing for peer nodes
      After=network.target
      Wants=network.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/configure-vip-routing
      
      [Install]
      WantedBy=multi-user.target

  - path: /usr/local/bin/configure-vip-routing
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      
      # Add route to VIP range in master's network (10.80.16.240/28) via default gateway
      # This allows peer nodes to reach the Kubernetes API VIP
      VIP_RANGE="10.80.16.240/28"
      GATEWAY=$(ip route show default | awk '/default/ { print $3; exit }')
      
      if [[ -n "$GATEWAY" ]]; then
        echo "Adding route to VIP range $VIP_RANGE via gateway $GATEWAY"
        ip route add "$VIP_RANGE" via "$GATEWAY" || {
          echo "Route already exists or failed to add"
          exit 0
        }
      else
        echo "Error: Could not determine default gateway"
        exit 1
      fi

runcmd:
  # Enable VIP routing configuration
  - systemctl enable configure-vip-routing.service
  - systemctl start configure-vip-routing.service

