apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: flox-runtime-installer
  namespace: flox-runtime # {"$kpt-set":"flox-namespace"}
  labels:
    app.kubernetes.io/name: flox-runtime-installer
    app.kubernetes.io/component: runtime-shim
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: flox-runtime-installer
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: flox-runtime-installer
        app.kubernetes.io/component: runtime-shim
    spec:
      serviceAccountName: flox-runtime-installer
      hostPID: true
      restartPolicy: Always
      tolerations:
        - operator: "Exists"
      nodeSelector:
        flox.dev/enabled: "true"
      initContainers:
        - name: shim-installer
          image: alpine:3.20
          imagePullPolicy: IfNotPresent
          env:
            - name: CONTAINERD_CONFIG_FILE
              value: /var/lib/rancher/rke2/agent/etc/containerd/config.toml # {"$kpt-set":"containerd-config-file"}
            - name: CONTAINERD_ADDRESS
              value: /run/k3s/containerd/containerd.sock # {"$kpt-set":"containerd-address"}
            - name: APK_MAX_RETRIES
              value: "5" # {"$kpt-set":"apk-max-retries"}
          securityContext:
            privileged: true
            runAsUser: 0
            runAsGroup: 0
          command:
            - /bin/sh
            - -c
            - |
              set -euxo pipefail

              install_deps() {
                local attempt=0
                local max_attempts=${APK_MAX_RETRIES:-5}
                while true; do
                  attempt=$((attempt + 1))
                  if apk update && apk add --no-cache bash util-linux coreutils >/tmp/apk.log; then
                    return 0
                  fi
                  if [[ ${attempt} -ge ${max_attempts} ]]; then
                    echo "apk install failed after ${attempt} attempts" >&2
                    sleep infinity
                  fi
                  sleep $((attempt * 2))
                done
              }

              install_deps

              nsenter --target 1 --mount --uts --ipc --net --pid -- env \
                CONTAINERD_CONFIG_FILE="${CONTAINERD_CONFIG_FILE}" \
                bash <<'HOSTSCRIPT'
              set -euxo pipefail
              export PATH="/var/lib/rancher/rke2/bin:/var/lib/rancher/rke2/agent/bin:${PATH}"
              export FLOX_NO_TELEMETRY=1
              export FLOX_NONINTERACTIVE=1

              CONFIG_FILE="${CONTAINERD_CONFIG_FILE}"
              CONFIG_DIR="$(dirname "${CONFIG_FILE}")"
              CONFIG_TEMPLATE="${CONFIG_DIR}/config.toml.tmpl"
              FLOX_ENV_DIR="/var/lib/flox-runtime/containerd-shim"
              ARCH="$(uname -m)"

              mkdir -p "${FLOX_ENV_DIR}"
              if [[ ! -d "${FLOX_ENV_DIR}/.flox" ]]; then
                (cd "${FLOX_ENV_DIR}" && flox init -b)
              fi

              if command -v containerd >/dev/null 2>&1; then
                CONTAINERD_BIN="$(command -v containerd)"
              elif [[ -x /var/lib/rancher/rke2/bin/containerd ]]; then
                CONTAINERD_BIN="/var/lib/rancher/rke2/bin/containerd"
              elif [[ -x /var/lib/rancher/rke2/agent/bin/containerd ]]; then
                CONTAINERD_BIN="/var/lib/rancher/rke2/agent/bin/containerd"
              else
                echo "containerd binary not found" >&2
                exit 1
              fi

              CONTAINERD_VERSION="$(${CONTAINERD_BIN} --version | awk '{print $3}')"
              CONTAINERD_VERSION="${CONTAINERD_VERSION#v}"
              CONTAINERD_MAJOR="${CONTAINERD_VERSION%%.*}"
              if [[ -z "${CONTAINERD_MAJOR}" ]]; then
                echo "unable to determine containerd version" >&2
                exit 1
              fi
              if [[ "${CONTAINERD_MAJOR}" -ge 2 ]]; then
                SHIM_PKG="flox/containerd-shim-flox-2x"
              else
                SHIM_PKG="flox/containerd-shim-flox-17"
              fi

              flox install --dir "${FLOX_ENV_DIR}" "${SHIM_PKG}"

              SHIM_RUN_DIR="$(find "${FLOX_ENV_DIR}/.flox/run" -maxdepth 1 -name "${ARCH}-linux.containerd-shim*.run" -print -quit || true)"
              if [[ -z "${SHIM_RUN_DIR}" ]]; then
                echo "unable to locate Flox shim run directory" >&2
                exit 1
              fi
              SHIM_PATH="$(realpath "${SHIM_RUN_DIR}")/bin/containerd-shim-flox-v2"
              if [[ ! -f "${SHIM_PATH}" ]]; then
                echo "shim binary missing at ${SHIM_PATH}" >&2
                exit 1
              fi
              install -D -m 0755 "${SHIM_PATH}" /usr/local/bin/containerd-shim-flox-v2

              if [[ ! -f "${CONFIG_TEMPLATE}" ]]; then
                cp "${CONFIG_FILE}" "${CONFIG_TEMPLATE}"
              fi

              CONFIG_VERSION="$(grep -m1 '^version' "${CONFIG_FILE}" | awk -F '=' '{print $2}' | tr -d ' "')"
              if [[ "${CONFIG_VERSION}" == "3" ]]; then
                RUNTIME_SECTION='plugins."io.containerd.cri.v1.runtime".containerd.runtimes.flox'
              else
                RUNTIME_SECTION='plugins."io.containerd.grpc.v1.cri".containerd.runtimes.flox'
              fi

              update_config() {
                local target="$1"
                [[ -f "${target}" ]] || return 0
                local tmp
                tmp="$(mktemp)"
                awk '
                  BEGIN {skip=0}
                  /^## Flox runtime shim/ {skip=1; next}
                  /^\[plugins\..*containerd\.runtimes\.flox/ {skip=1; next}
                  skip && /^\[/ && $0 !~ /containerd\.runtimes\.flox/ {skip=0}
                  skip {next}
                  {print}
                ' "${target}" > "${tmp}"
                mv "${tmp}" "${target}"
                cat <<EOF_BLOCK | sed "s|__RUNTIME_SECTION__|${RUNTIME_SECTION}|" | sed 's/^              //' >> "${target}"
              ## Flox runtime shim
              [__RUNTIME_SECTION__]
                runtime_path = "/usr/local/bin/containerd-shim-flox-v2"
                runtime_type = "io.containerd.runc.v2"
                pod_annotations = [ "flox.dev/*" ]
                container_annotations = [ "flox.dev/*" ]
              [__RUNTIME_SECTION__.options]
                SystemdCgroup = true
              EOF_BLOCK
              }

              update_config "${CONFIG_FILE}"
              update_config "${CONFIG_TEMPLATE}"

              if systemctl is-active rke2-server >/dev/null; then
                systemctl restart rke2-server
              elif systemctl is-active rke2-agent >/dev/null; then
                systemctl restart rke2-agent
              elif systemctl is-active containerd >/dev/null; then
                systemctl restart containerd
              else
                echo "no known service to restart" >&2
              fi
              HOSTSCRIPT
      containers:
        - name: pause
          image: registry.k8s.io/pause:3.10
          resources:
            requests:
              cpu: 5m
              memory: 32Mi
            limits:
              cpu: 10m
              memory: 64Mi
      volumes: []
