# incus preseed for rke2 cluster (LAN bridge + cluster bridge) (@codebase)
#
# Architecture:
# - lan0: Bridged to vmlan1 (Lima interface) for PRIMARY internet access via home router DHCP
# - vmnet0: Incus-managed bridge network for inter-node cluster communication ONLY
#
# vmlan0: Lima VM's own interface with IP for host management
# vmlan1: Dedicated unconfigured interface for Incus lan-br bridge
#
# Current routing strategy (November 2025):
# - Internet: via lan0 (metric 100) → home router → reliable NAT
# - Cluster: via vmnet0 (metric 9999) → Lima VM bridge → node-to-node communication
# - Lima VM NAT disabled due to TCP reliability issues (ICMP works, TCP timeouts)
#
# LAN bridge allows containers to get DHCP from home router without macvlan/ipvlan issues
config: {}
storage_pools:
  - name: default
    driver: zfs
    config:
      source: tank/nerd/incus
# Incus-managed bridge network for cluster node communication
# Provides inter-node connectivity within the VM cluster
# Internet access is exclusively via lan0/home router
# Cluster allocation: 10.80.(CLUSTER_ID * 8).0/21
networks:
  - name: vmnet-br
    type: bridge
    config:
      ipv4.address: 10.80.8.1/21
      ipv4.nat: "false" # NAT disabled - cluster-internal only
      ipv4.routing: "false" # No routing - isolated bridge
      ipv4.dhcp: "true"
      ipv4.dhcp.ranges: 10.80.8.2-10.80.8.9,10.80.8.31-10.80.15.254
      dns.mode: none
      bridge.driver: native
      # Static DHCP leases for RKE2 nodes - ensures predictable IP allocation
      # Format: dhcp-host=MAC,IP,hostname
      # MACs use QEMU prefix 52:54:00 + cluster_id:node_type:node_id (in hex, zero-padded)
      # IPs use cluster network base + node offset (10 for master, 11-13 for peers, 20+ for workers)
      raw.dnsmasq: |
        dhcp-host=52:54:00:01:00:00,10.80.8.10,master
        dhcp-host=52:54:00:01:00:01,10.80.8.11,peer1
        dhcp-host=52:54:00:01:00:02,10.80.8.12,peer2
        dhcp-host=52:54:00:01:00:03,10.80.8.13,peer3
        dhcp-host=52:54:00:01:01:0a,10.80.8.20,worker1
        dhcp-host=52:54:00:01:01:0b,10.80.8.21,worker2
profiles:
  - name: rke2lab
    description: RKE2 profile (LAN bridge + cluster bridge)
    devices:
      root:
        path: /
        pool: default
        type: disk
      lan0:
        name: lan0
        nictype: bridged
        parent: lan-br
        type: nic
      vmnet0:
        name: vmnet0
        network: vmnet-br
        type: nic
