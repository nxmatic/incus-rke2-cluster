---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  annotations:
    internal.kpt.dev/upstream-identifier: apps|DaemonSet|flox-runtime|flox-runtime-installer
    kpt.dev/package-layer: runtime
    kpt.dev/package-name: flox-containerd-shim
  labels:
    app.kubernetes.io/component: runtime-shim
    app.kubernetes.io/name: flox-runtime-installer
  name: flox-runtime-installer
  namespace: flox-runtime
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: flox-runtime-installer
  template:
    metadata:
      annotations:
        kpt.dev/package-layer: runtime
        kpt.dev/package-name: flox-containerd-shim
      labels:
        app.kubernetes.io/component: runtime-shim
        app.kubernetes.io/name: flox-runtime-installer
    spec:
      automountServiceAccountToken: false
      containers:
        - image: registry.k8s.io/pause:3.10
          name: pause
          resources:
            limits:
              cpu: 10m
              ephemeral-storage: 64Mi
              memory: 64Mi
            requests:
              cpu: 5m
              ephemeral-storage: 32Mi
              memory: 32Mi
      hostPID: true
      initContainers:
        - command:
            - /bin/sh
            - /scripts/shim-installer.sh
          env:
            - name: CONTAINERD_CONFIG_FILE
              value: /var/lib/rancher/rke2/agent/etc/containerd/config.toml
            - name: CONTAINERD_ADDRESS
              value: /run/k3s/containerd/containerd.sock
            - name: APK_MAX_RETRIES
              value: "5"
          image: alpine:3.20
          imagePullPolicy: IfNotPresent
          name: shim-installer
          securityContext:
            privileged: true
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /scripts
              name: runtime-installer-script
              readOnly: true
      nodeSelector:
        flox.dev/enabled: "true"
      restartPolicy: Always
      serviceAccountName: flox-runtime-installer
      tolerations:
        - operator: Exists
      volumes:
        - configMap:
            defaultMode: 493
            name: flox-runtime-installer-script
          name: runtime-installer-script
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
