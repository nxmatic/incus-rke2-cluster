apiVersion: v1
kind: ServiceAccount
metadata:
  name: headscale-client
  namespace: ${headscale-namespace} # kpt-set: ${headscale-namespace}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: headscale-client
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: headscale-client
subjects:
- kind: ServiceAccount
  name: headscale-client
  namespace: ${headscale-namespace} # kpt-set: ${headscale-namespace}
roleRef:
  kind: ClusterRole
  name: headscale-client
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: headscale-client
  namespace: ${headscale-namespace} # kpt-set: ${headscale-namespace}
  labels:
    app: headscale-client
spec:
  selector:
    matchLabels:
      app: headscale-client
  template:
    metadata:
      labels:
        app: headscale-client
      annotations:
        flox.dev/environment: "${headscale-flox-env}" # kpt-set: ${headscale-flox-env}
    spec:
      runtimeClassName: flox
      serviceAccountName: headscale-client
      hostNetwork: true
      hostPID: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        node-role.kubernetes.io/control-plane: "true"
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      initContainers:
      - name: wait-for-headscale
        image: flox/empty:1.0.0
        envFrom:
        - configMapRef:
            name: headscale-env
        - configMapRef:
            name: flox-env
        env:
        command:
        - bash
        - /scripts/wait-for-headscale.sh
        volumeMounts:
        - name: client-scripts
          mountPath: /scripts
          readOnly: true
      - name: wait-for-authkey
        image: flox/empty:1.0.0
        envFrom:
        - configMapRef:
            name: headscale-env
        - configMapRef:
            name: flox-env
        env:
        command:
        - bash
        - /scripts/wait-for-authkey.sh
        volumeMounts:
        - name: authkey
          mountPath: /var/secrets
        - name: client-scripts
          mountPath: /scripts
          readOnly: true
      containers:
      - name: tailscale
        image: flox/empty:1.0.0
        envFrom:
        - configMapRef:
            name: headscale-env
        - configMapRef:
            name: flox-env
        env:
        - name: RKE2_NODENAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: TS_AUTHKEY
          valueFrom:
            secretKeyRef:
              name: headscale-client-auth
              key: authkey
        - name: TS_STATE_DIR
          value: /var/lib/tailscale
        - name: TS_SOCKET
          value: /var/run/tailscale/tailscaled.sock
        - name: TS_USERSPACE
          value: "true"
        - name: TS_KUBE_SECRET
          value: ""
        command:
        - bash
        - /scripts/tailscale-client.sh
        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
        volumeMounts:
        - name: dev-net-tun
          mountPath: /dev/net/tun
        - name: tailscale-state
          mountPath: /var/lib/tailscale
        - name: tailscale-socket
          mountPath: /var/run/tailscale
        - name: authkey
          mountPath: /var/secrets
          readOnly: true
        - name: client-scripts
          mountPath: /scripts
          readOnly: true
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
            ephemeral-storage: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
            ephemeral-storage: 256Mi
      volumes:
      - name: dev-net-tun
        hostPath:
          path: /dev/net/tun
          type: CharDevice
      - name: tailscale-state
        hostPath:
          path: /var/lib/tailscale
          type: DirectoryOrCreate
      - name: tailscale-socket
        emptyDir: {}
      - name: client-scripts
        configMap:
          name: headscale-client-scripts
          defaultMode: 0755
      - name: authkey
        secret:
          secretName: headscale-client-auth
          items:
          - key: authkey
            path: authkey
