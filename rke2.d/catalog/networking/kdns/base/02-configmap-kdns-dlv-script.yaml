apiVersion: v1
kind: ConfigMap
metadata:
  name: kdns-dlv-script
  namespace: ${target-namespace} # kpt-set: ${target-namespace}
data:
  kdns-dlv.sh: |
    #!/usr/bin/env -S bash -exuo pipefail
  
    enabled="${KDNS_DEBUG_ENABLED:-}"
    if [ "$enabled" != "true" ]; then
      : "[i] debug disabled (set annotation debug.kdns.lab42/enabled=true to enable); sleeping"
      sleep 3650d
    fi
    apk add --no-cache wget ca-certificates >/dev/null
    arch=$(uname -m)
    case "$arch" in
      x86_64) arch=amd64 ;;
      aarch64) arch=arm64 ;;
    esac
    dlv_version="1.22.1"
    url="https://github.com/go-delve/delve/releases/download/v${dlv_version}/dlv_${dlv_version}_linux_${arch}.tar.gz"
    echo "[kdns-dlv] fetching dlv ${dlv_version} from ${url}"
    wget -qO /tmp/dlv.tgz "$url"
    tar -xzf /tmp/dlv.tgz -C /tmp
    chmod +x /tmp/dlv
    target_pid=$(pidof kdns || true)
    if [ -z "$target_pid" ]; then
      : "[i] kdns process not found; sleeping"
      sleep 1d
    fi
    : "[i] starting delve headless on :${KDNS_DEBUG_PORT} attaching to pid ${target_pid}"
    exec /tmp/dlv attach "$target_pid" --headless --listen=":${KDNS_DEBUG_PORT}" --api-version=2 --accept-multiclient --log --continue