# yaml-language-server: $schema=https://raw.githubusercontent.com/canonical/netplan/main/netplan/cli/schema.json
# network-config (NoCloud datasource) (@codebase)
#
# MANDATORY SEPARATION: Modern cloud-init requires network configuration to be separated
# from user-data to prevent parsing issues. Older cloud-init versions failed silently
# when network config was embedded, causing truncated interface configuration.
#
# Use networkd renderer for systemd-networkd management (shows as "managed" in networkctl).
# Disable IPv6 on lan0 to avoid DHCPv6 client dependency issues that break ifupdown parsing.
network:
  version: 2
  renderer: networkd
  ethernets:
    # ===== LAN INTERFACE (DHCP) =====
    # Local network access for dedicated load balancers
    lan0:
      # DHCP Configuration with strict overrides
      dhcp4: true
      dhcp4-overrides:
        use-routes: false      # Prevent ALL routes from DHCP
        use-dns: false         # Prevent DNS override from DHCP
        use-domains: false     # Prevent domain override from DHCP
        use-hostname: false    # Prevent hostname override
        send-hostname: false   # Don't send hostname to DHCP server
        route-metric: 9999     # Set extremely high metric as last resort
      dhcp6: false             # Disable IPv6 DHCP
      dhcp-identifier: mac

      # Interface Options
      optional: false

    # ===== WAN INTERFACE (DHCP from Incus bridge) =====
    # Cluster network + internet access via Lima VM gateway
    # Lima VM acts as gateway at .1 of each cluster's /21 network
    wan0:
      # DHCP from Incus wan bridge network
      dhcp4: true
      dhcp4-overrides:
        route-metric: 100        # Default route for internet access via Lima VM
        use-dns: true            # Use DNS from bridge network
        use-routes: true         # Accept default route from DHCP

      # Interface Options
      optional: false
