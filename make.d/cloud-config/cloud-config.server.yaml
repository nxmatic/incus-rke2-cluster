# Shared configuration for all RKE2 server nodes (master, peer1, peer2)
# Contains shared server components, bootstrap manifests are in master config

write_files:
  # =============================================================================
  # SHARED RKE2 CONTROL PLANE CONFIGURATION
  # =============================================================================

  # Core RKE2 server configuration (shared across all control plane nodes)
  - path: /etc/rancher/rke2/config.yaml.d/core.yaml
    content: |
      write-kubeconfig-mode: "0640"
      bind-address: "0.0.0.0"
      cni:
        - cilium
      ingress-controller: traefik


  # Dedicated token fragment
  - path: /etc/rancher/rke2/config.yaml.d/token.yaml
    content: |
      token: ${CLUSTER_TOKEN}

  # Dedicated advertise-address fragment
  - path: /etc/rancher/rke2/config.yaml.d/advertise-address.yaml
    content: |
      advertise-address: ${NODE_HOST_IP}

  # Deterministic node labels for scheduling / selectors
  - path: /etc/rancher/rke2/config.yaml.d/node-labels.yaml
    content: |
      node-label:
        - ${CLUSTER_NAME}.cluster/node-role=${NODE_ROLE}
        - ${CLUSTER_NAME}.cluster/node-type=${NODE_TYPE}

  # Disable default controllers we don't want (consistent across cluster)
  - path: /etc/rancher/rke2/config.yaml.d/disable.yaml
    content: |
      disable:
        - rke2-snapshot-controller
        - rke2-snapshot-controller-crd
        - rke2-snapshot-validation-webhook
        - rke2-ingress-nginx

  # =============================================================================
  # SHARED SYSTEMD SERVICE OVERRIDES
  # =============================================================================

  # Main RKE2 server service override (consistent restart behavior)
  - path: /etc/systemd/system/rke2-server.service.d/override.conf
    content: |
      [Service]
      Restart=always
      RestartSec=10s
      [Install]
      WantedBy=multi-user.target

  # Pre-start configuration for all control plane nodes
  - path: /etc/systemd/system/rke2-server.service.d/pre-start.conf
    content: |
      [Unit]
      Requires=rke2-remount-shared.service rke2-install.service
      Wants=rke2-remount-shared.service
      After=rke2-remount-shared.service rke2-install.service
      [Service]
      ExecStartPre=/bin/sh -xc '/usr/local/sbin/rke2-pre-start'

  # Post-start configuration for all control plane nodes (but no Cilium check)
  - path: /etc/systemd/system/rke2-server.service.d/post-start.conf
    content: |
      [Service]
      # Wait for Kubernetes API to be ready before considering service started
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStartPost=/bin/bash -c 'source <(flox activate --dir /var/lib/rancher/rke2) && until kubectl get --raw /readyz &>/dev/null; do echo "Waiting for API server..."; sleep 5; done && echo "API server is ready"'
      # Note: Cilium check is only run on master node via post-start-master.conf

  # =============================================================================
  # SHARED CONTROL PLANE SCRIPTS
  # =============================================================================

  # Control plane pre-start script (shared logic for all server nodes)
  - path: /usr/local/sbin/rke2-pre-start
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-pre-start.sh

  # Generate RKE2 static manifests from environment variables (called by pre-start)
  - path: /usr/local/sbin/rke2-manifests-install
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-manifests-install.sh

  # One-shot service to install static manifests after rke2-server is up
  - path: /etc/systemd/system/rke2-manifests-install.service
    content: |
      [Unit]
      Description=Install RKE2 static manifests
      After=rke2-server.service
      Requires=rke2-server.service
      ConditionPathExists=/usr/local/sbin/rke2-manifests-install

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-manifests-install

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable rke2-manifests-install.service
  - systemctl start rke2-manifests-install.service
