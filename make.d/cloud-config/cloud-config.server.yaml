# Shared configuration for all RKE2 server nodes (master, peer1, peer2)
# Contains shared server components, bootstrap manifests are in master config

write_files:
  # Main RKE2 server service override (consistent restart behavior)
  - path: /etc/systemd/system/rke2-server.service.d/override.conf
    content: |
      [Service]
      Restart=always
      RestartSec=10s
      [Install]
      WantedBy=multi-user.target

  # Pre-start configuration for all control plane nodes
  - path: /etc/systemd/system/rke2-server.service.d/pre-start.conf
    content: |
      [Unit]
      Requires=rke2-remount-shared.service rke2-install.service
      Wants=rke2-remount-shared.service
      After=rke2-remount-shared.service rke2-install.service
      [Service]
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStartPre=/bin/sh -xc '/usr/local/sbin/rke2-server-pre-start'
      ExecStartPre=/bin/sh -xc '/usr/local/sbin/rke2-config-install'
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-server-post-start'

  # Post-start configuration for all control plane nodes (but no Cilium check)
  - path: /etc/systemd/system/rke2-server.service.d/post-start.conf
    content: |
      [Service]
      # Wait for Kubernetes API to be ready before considering service started
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStartPost=/bin/bash -c 'source <(flox activate --dir /var/lib/rancher/rke2) && until kubectl get --raw /readyz &>/dev/null; do echo "Waiting for API server..."; sleep 5; done && echo "API server is ready"'
      # Note: Cilium check is only run on master node via post-start-master.conf

  # =============================================================================
  # SHARED CONTROL PLANE SCRIPTS
  # =============================================================================

  # Control plane pre-start script (shared logic for all server nodes)
  - path: /usr/local/sbin/rke2-server-pre-start
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-server-pre-start.sh

  # Control plane post-start script (shared logic for all server nodes)
  - path: /usr/local/sbin/rke2-server-post-start
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-server-post-start.sh    
  - path: /usr/local/sbin/rke2-config-install
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-config-install.sh

runcmd:
  - systemctl daemon-reload
