# Full profile overlay: adds Cilium full-feature HelmChartConfig + cluster resources
# @codebase

write_files:
  - path: /etc/systemd/system/rke2-cilium-config.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Deploy Cilium HelmChartConfig via kpt
      After=rke2-server.service rke2-kpt-package-sync.service
      Requires=rke2-server.service rke2-kpt-package-sync.service
      ConditionPathExists=${CLUSTER_STATE_DIR}/kpt/system/cilium-config

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=${CLUSTER_STATE_DIR}/kpt/system/cilium-config
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStart=/usr/local/sbin/rke2-kpt-deploy ${CLUSTER_STATE_DIR}/kpt/system/cilium-config --timeout=5m -- cluster-name=${CLUSTER_NAME} cluster-id=${CLUSTER_SUBNET}
      Restart=on-failure
      RestartSec=10s

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable rke2-cilium-config.service
  - systemctl start rke2-cilium-config.service

# Cilium advanced features (BGP, L2, IP pools) migrated to kpt package
# See: ${CLUSTER_STATE_DIR}/${CLUSTER_NAME}/networking/cilium

# Envoy Gateway removed - now managed via kpt package
# See: ${CLUSTER_STATE_DIR}/${CLUSTER_NAME}/networking/envoy-gateway