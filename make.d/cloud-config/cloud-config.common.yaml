# Common cloud-init configuration for all RKE2 nodes (masters and agents)

hostname: ${NODE_NAME}-control-node

manage_resolv_conf: true
resolv_conf:
  searchdomains:
    - mammoth-skate.ts.net

# -----------------------------------------------------------------------------
# Network configuration now provided via separate NoCloud network-config file (@codebase)
# The standalone network-config.yaml template generates the network-config seed file
# mounted at /var/lib/cloud/seed/nocloud/network-config. Since cloud-init doesn't
# properly honor the 'renderer: networkd' directive, we use bootcmd to install the
# netplan file before systemd-networkd starts.
# -----------------------------------------------------------------------------

bootcmd:
  # Install NoCloud network-config as netplan file before cloud-init processes network
  # This must run in bootcmd because write_files happens too late (after network config)
  - [ test, -f, /var/lib/cloud/seed/nocloud/network-config ]
  - [ cp, /var/lib/cloud/seed/nocloud/network-config, /etc/netplan/01-nocloud.yaml ]
  - [ chmod, '600', /etc/netplan/01-nocloud.yaml ]
  # Disable dhcpcd for vmnet0 - systemd-networkd will handle it
  - [ sh, -c, "echo 'denyinterfaces vmnet0' >> /etc/dhcpcd.conf" ]  

write_files:
  # =============================================================================
  # SYSTEM CONFIGURATION FILES
  # =============================================================================

  # Disable cloud-init network configuration to prevent conflicts with netplan/systemd-networkd
  # This prevents cloud-init from generating /etc/network/interfaces.d/50-cloud-init
  # which would start dhcpcd and conflict with systemd-networkd DHCP
  - path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    permissions: "0644"
    content: |
      network: {config: disabled}

  # systemd-networkd drop-in to set cluster-prefixed hostname for LAN DHCP
  # This ensures LAN DHCP registrations are unique per cluster (bioskop vs alcide)
  # while keeping the actual system hostname unchanged
  # Drop-in must match netplan-generated config name: 10-netplan-lan0.network
  - path: /etc/systemd/network/10-netplan-lan0.network.d/10-hostname.conf
    permissions: "0644"
    content: |
      [DHCP]
      SendHostname=yes
      Hostname=${CLUSTER_NAME}-${NODE_NAME}-control-node

  # systemd-networkd drop-in to prevent vmnet0 DHCP from installing routes/DNS
  - path: /etc/systemd/network/10-netplan-lan0.network.d/90-no-default.conf
    permissions: "0644"
    content: |
      [Network]
      DHCP=ipv4
      IPv6AcceptRA=no
      LinkLocalAddressing=ipv4
      LLMNR=yes

      [DHCP]
      UseDNS=yes

  # systemd-networkd drop-in to prevent vmnet0 DHCP from installing routes/DNS
  - path: /etc/systemd/network/10-netplan-vmnet0.network.d/90-no-default.conf
    permissions: "0644"
    content: |
      [Network]
      IPv6AcceptRA=no
      LinkLocalAddressing=ipv4

      [DHCP]
      UseRoutes=no
      UseDNS=no

  # systemd-resolved drop-in to disable LLMNR/mDNS advertising on LAN interfaces
  - path: /etc/systemd/resolved.conf.d/10-disable-llmnr-mdns.conf
    permissions: "0644"
    content: |
      [Resolve]
      LLMNR=no
      MulticastDNS=no

  # Disable IPv6 globally so nodes stay IPv4-only end-to-end (@codebase)
  - path: /etc/sysctl.d/99-disable-ipv6.conf
    permissions: "0644"
    content: |
      net.ipv6.conf.all.disable_ipv6 = 1
      net.ipv6.conf.default.disable_ipv6 = 1
      net.ipv6.conf.lo.disable_ipv6 = 1
      net.ipv6.conf.lan0.disable_ipv6 = 1
      net.ipv6.conf.vmnet0.disable_ipv6 = 1
      net.ipv6.conf.all.accept_ra = 0
      net.ipv6.conf.default.accept_ra = 0

  # Network configuration script using flox environment and yq
  - path: /usr/local/sbin/rke2-network-config
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-network-config.sh
  - path: /etc/systemd/system/rke2-network-config.service
    permissions: "0644"
    content: |
      [Unit]
      Description=RKE2 Network Configuration Service
      After=systemd-networkd.service cloud-init.service
      Wants=systemd-networkd.service
      Before=rke2-install.service
      
      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-network-config
      RemainAfterExit=yes
      StandardOutput=journal
      StandardError=journal
      
      [Install]
      WantedBy=multi-user.target

  # Docker CLI shim to route invocations to nerdctl for kpt functions
  - path: /usr/local/bin/docker
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/docker.sh

  # =============================================================================
  # KUBELET CONFIGURATION FILES
  # =============================================================================

  # Set systemd as cgroup driver
  - path: /var/lib/rancher/rke2/agent/etc/kubelet.conf.d/01-cgroup-override.conf
    content: |
      apiVersion: kubelet.config.k8s.io/v1beta1
      kind: KubeletConfiguration
      cgroupDriver: systemd

  # Disable aggressive image garbage collection
  - path: /var/lib/rancher/rke2/agent/etc/kubelet.conf.d/00-disable-gc.conf
    content: |
      apiVersion: kubelet.config.k8s.io/v1beta1
      kind: KubeletConfiguration
      kubelet-arg:
        imageGCHighThresholdPercent: 100
        imageGCLowThresholdPercent: 99

  # =============================================================================
  # CONTAINERD CONFIGURATION
  # =============================================================================

  # ZFS snapshotter configuration for containerd
  - path: /var/lib/rancher/rke2/agent/etc/containerd/config-v3.toml
    permissions: "0644"
    content: |
      {{ template "base" . }}

      [plugins."io.containerd.grpc.v1.cri".containerd]
        snapshotter = "zfs"

      [plugins."io.containerd.snapshotter.v1.zfs"]
        root_path = "/var/lib/rancher/rke2/agent/containerd/io.containerd.snapshotter.v1.zfs"

      [debug]
        level = "debug"

  # =============================================================================
  # FLOX ENVIRONMENT SETUP SCRIPTS
  # =============================================================================

  # Pre-installation script for environment setup
  - path: /usr/local/sbin/rke2-install-pre
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-install-pre.sh
  - path: /usr/local/sbin/rke2-install
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-install.sh
  - path: /usr/local/sbin/rke2-install-post
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-install-post.sh
  - path: /etc/systemd/system/rke2-server.service.d/kubeconfig.conf
    content: |
      [Service]
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-tools-configuration-directories'
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-vip-kubeconfig'

  - path: /etc/systemd/system/rke2-agent.service.d/kubeconfig.conf
    content: |
      [Service]
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-tools-configuration-directories'
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-vip-kubeconfig'

  # Control plane specific systemd drop-in for Cilium operator scaling
  # - path: /etc/systemd/system/rke2-server.service.d/cilium-operator-scaling.conf
  #   content: |
  #     [Service]
  #     ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-cilium-operator-scaling'

  # =============================================================================
  # ENVIRONMENT CONFIGURATION FILES
  # =============================================================================

  # Simplified RKE2 environment configuration (variables now in flox profile)
  - path: /var/lib/rancher/rke2/.envrc
    permissions: "0644"
    content: |
      #!/usr/bin/env bash
      log_status "Loading RKE2 flox environment"

      # Variables are now defined in flox profile-common.sh
      # Just activate flox environment
      [[ "$${FLOX_ENV_PROJECT}" != "$${PWD}" ]] &&
        use flox

  # =============================================================================
  # SHELL CONFIGURATION FILES
  # =============================================================================

  # Root user zsh configuration
  - path: /root/.zshrc
    permissions: "0644"
    content: |
      #!/usr/bin/env zsh

      : "Define useful functions"
      journalctl:unit:follow() {
        local unit="$$1"
        journalctl --unit $$unit --follow --no-tail |
          tee /.logs.d/$${unit}.log
      }

      : "Configure completions"
      autoload -Uz compinit &&
        compinit
      command -v kubectl >/dev/null &&
        source <( kubectl completion zsh ) 2>/dev/null || true
      command -v helm >/dev/null &&
        source <( helm completion zsh ) 2>/dev/null || true

      : "Load direnv hook"
      source <( direnv hook zsh )

  # Bash completion for kubectl and helm
  - path: /etc/bash_completion.d/kube
    permissions: "0644"
    content: |
      #!/usr/bin/env -S bash
      source <( flox activate --dir /var/lib/rancher/rke2 )

      source <( kubectl completion bash ) 2>/dev/null || true
      source <( helm completion bash ) 2>/dev/null || true

  # =============================================================================
  # UTILITY SCRIPTS
  # =============================================================================

  - path: /usr/local/sbin/rke2-route-cleanup
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-route-cleanup.sh
  - path: /usr/local/sbin/rke2-network-wait
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-network-wait.sh
  - path: /usr/local/sbin/rke2-network-debug
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-network-debug.sh
  - path: /usr/local/sbin/rke2-remount-shared
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-remount-shared.sh
  - path: /usr/local/sbin/rke2-activate
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-activate.sh
  - path: /usr/local/sbin/rke2-enable-containerd-zfs-mount
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-enable-containerd-zfs-mount.sh
  - path: /usr/local/sbin/rke2-cilium-operator-scaling
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-cilium-operator-scaling.sh
  - path: /usr/local/sbin/rke2-tools-configuration-directories
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-tools-configuration-directories.sh
  - path: /usr/local/sbin/rke2-vip-kubeconfig
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-vip-kubeconfig.sh
  - path: /usr/local/sbin/rke2-cilium-check
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-cilium-check.sh
  - path: /etc/systemd/system/rke2-network-debug.service
    permissions: "0644"
    content: |
      [Unit]
      Description=RKE2 Network Debug Logger
      After=systemd-networkd.service

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c 'echo "=== Network Debug at $$(date) ==="; ip addr show; echo "=== Routes ==="; ip route show; echo "=== NetworkD Status ==="; systemctl status systemd-networkd --no-pager; echo "=== NetworkCTL List ==="; networkctl list'
      RemainAfterExit=true
      StandardOutput=journal+console
      StandardError=journal+console

      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/rke2-network-wait.service
    permissions: "0644"
    content: |
      [Unit]
      Description=RKE2 Network Wait Service
      After=systemd-networkd.service
      Before=rke2-server.service rke2-agent.service
      Wants=systemd-networkd.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-network-wait
      RemainAfterExit=true
      StandardOutput=journal+console
      StandardError=journal+console
      SuccessExitStatus=0 1

      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/rke2-route-cleanup.service
    permissions: "0644"
    content: |
      [Unit]
      Description=RKE2 Route Cleanup Service - Remove DHCP default routes
      After=network-online.target systemd-networkd.service
      Wants=network-online.target systemd-networkd.service
      Before=rke2-server.service rke2-agent.service
      StartLimitIntervalSec=30

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-route-cleanup
      RemainAfterExit=true
      StandardOutput=journal+console
      StandardError=journal+console
      Restart=on-failure
      RestartSec=5
      StartLimitBurst=3

      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/zfs-early-umount.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Early ZFS umount all datasets
      After=zfs-mount.service
      Before=basic.target
      DefaultDependencies=no

      [Service]
      Type=oneshot
      ExecStart=/usr/sbin/zfs umount -a

      [Install]
      WantedBy=basic.target
  - path: /etc/systemd/system/rke2-remount-shared.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Remount RKE2 required volumes as shared
      Before=rke2-server.service
      DefaultDependencies=no

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-remount-shared
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/rke2-install.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Run RKE2 Installation Script
      After=network-online.target systemd-networkd.service
      Wants=network-online.target systemd-networkd.service
      ConditionPathExists=!/etc/systemd/system/rke2-server.service
      ConditionPathExists=!/etc/systemd/system/rke2-agent.service

      [Service]
      Type=oneshot
      ExecStartPre=/usr/local/sbin/rke2-install-pre
      ExecStart=/usr/local/sbin/rke2-install
      ExecStartPost=/usr/local/sbin/rke2-install-post
      RemainAfterExit=true
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

runcmd:
  - [ sysctl, -p, /etc/sysctl.d/99-disable-ipv6.conf ]
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable,
      rke2-network-config.service,
      rke2-network-debug.service,
      rke2-network-wait.service,
      rke2-route-cleanup.service,
      zfs-early-umount.service,
      rke2-remount-shared.service,
      rke2-install.service ]
  # Start network configuration service immediately
  - [ systemctl, start, rke2-network-config.service ]
  - /usr/local/sbin/rke2-activate
