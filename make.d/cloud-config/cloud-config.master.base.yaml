# Base master cloud-config (profile-agnostic)
# Contains all master-specific and bootstrap components EXCEPT any Cilium profile manifests.
# @codebase

write_files:
  # Master ETCD config
  - path: /etc/rancher/rke2/config.yaml.d/etcd.yaml
    content: |
      etcd-expose-metrics: true
      node-name: master-control-node
      with-node-id: false

  # Cluster init
  - path: /etc/rancher/rke2/config.yaml.d/cluster-init.yaml
    content: |
      cluster-init: true

  # Cilium validation execution (script itself is in common.yaml, available on all nodes)
  - path: /etc/systemd/system/rke2-server.service.d/post-start-master.conf
    content: |
      [Service]
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-cilium-check'

  # Traefik config (bootstrap)
  - path: /var/lib/rancher/rke2/server/manifests/rke2-traefik-config.yaml
    content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: rke2-traefik
        namespace: kube-system
      spec:
        valuesContent: |-
          additionalArguments:
            - "--api.insecure=true"
          ports:
            web:
              expose:
                default: true
            websecure:
              expose:
                default: true

  # (Envoy Gateway manifest moved to full overlay)

  # OpenEBS ZFS - MIGRATED to kpt package
  # See: kpt/catalog/storage/openebs-zfs/
  # Deployed by: kpt-deploy-openebs-zfs.service
  # Provides: persistent storage backed by ZFS

  # Tailscale operator - MIGRATED to kpt package
  # See: kpt/catalog/mesh/tailscale/
  # Deployed by: kpt-deploy-tailscale-operator.service, kpt-deploy-tailscale-connector.service
  # Provides: mesh networking, subnet routing for VIP + LoadBalancer pool

  # Downstream Git repository sync unit (control-plane only)
  - path: /etc/systemd/system/rke2-cluster-repo-sync.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Sync downstream cluster Git repository
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-cluster-repo-sync
      RemainAfterExit=yes
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  # Downstream kpt package sync unit (control-plane only)
  - path: /etc/systemd/system/rke2-kpt-package-sync.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Sync kpt packages into downstream repo
      After=rke2-cluster-repo-sync.service
      Requires=rke2-cluster-repo-sync.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-kpt-package-sync
      RemainAfterExit=yes
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  # Porch bootstrap service - deploys namespace, repositories, and PackageVariants
  - path: /etc/systemd/system/rke2-porch-bootstrap.service
    content: |
      [Unit]
      Description=Bootstrap Porch controllers
      After=rke2-server.service rke2-system-replicator.service rke2-kpt-package-sync.service
      Wants=rke2-server.service rke2-kpt-package-sync.service
      Requires=rke2-system-replicator.service rke2-kpt-package-sync.service
      ConditionPathExists=${CLUSTER_STATE_DIR}/kpt/system/porch

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=${CLUSTER_STATE_DIR}/kpt/system/porch
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStart=/usr/local/sbin/rke2-kpt-deploy ${CLUSTER_STATE_DIR}/kpt/system/porch --timeout=5m -- porch-docker-config-json=${CLUSTER_DOCKER_CONFIG_JSON}
      Restart=on-failure
      RestartSec=10s

      [Install]
      WantedBy=multi-user.target

  # Porch resources service - applies repositories, secrets, PV/PVS after controllers
  - path: /etc/systemd/system/rke2-porch-resources.service
    content: |
      [Unit]
      Description=Apply Porch repositories and PackageVariants
      After=rke2-porch-bootstrap.service rke2-kpt-package-sync.service
      Requires=rke2-porch-bootstrap.service rke2-kpt-package-sync.service
      ConditionPathExists=${CLUSTER_STATE_DIR}/kpt/system/porch-resources

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=${CLUSTER_STATE_DIR}/kpt/system/porch-resources
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStart=/usr/local/sbin/rke2-kpt-deploy ${CLUSTER_STATE_DIR}/kpt/system/porch-resources --timeout=5m -- cluster-github-token=${CLUSTER_GITHUB_TOKEN}
      Restart=on-failure
      RestartSec=10s

      [Install]
      WantedBy=multi-user.target

  # mittwald kubernetes-replicator controller (Helm-rendered kpt package)
  - path: /etc/systemd/system/rke2-system-replicator.service
    content: |
      [Unit]
      Description=Deploy mittwald kubernetes-replicator controller
      After=rke2-server.service rke2-kpt-package-sync.service
      Requires=rke2-server.service rke2-kpt-package-sync.service
      ConditionPathExists=${CLUSTER_STATE_DIR}/kpt/system/replicator

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=${CLUSTER_STATE_DIR}/kpt/system/replicator
      EnvironmentFile=/etc/rancher/rke2/environment
      ExecStart=/usr/local/sbin/rke2-kpt-deploy ${CLUSTER_STATE_DIR}/kpt/system/replicator --timeout=5m
      Restart=on-failure
      RestartSec=10s

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Enable and start Porch bootstrap service
  - systemctl daemon-reload
  - systemctl enable rke2-cluster-repo-sync.service
  - systemctl enable rke2-kpt-package-sync.service
  - systemctl start rke2-cluster-repo-sync.service
  - systemctl start rke2-kpt-package-sync.service
  - systemctl enable rke2-system-replicator.service
  - systemctl start rke2-system-replicator.service
  - systemctl enable rke2-porch-bootstrap.service
  - systemctl start rke2-porch-bootstrap.service
  - systemctl enable rke2-porch-resources.service
  - systemctl start rke2-porch-resources.service
