# Base master cloud-config (profile-agnostic)
# Contains all master-specific and bootstrap components EXCEPT any Cilium profile manifests.
# @codebase

write_files:
  # Master ETCD config
  - path: /etc/rancher/rke2/config.yaml.d/etcd.yaml
    content: |
      etcd-expose-metrics: true
      node-name: master-control-node
      with-node-id: false

  # Cluster init
  - path: /etc/rancher/rke2/config.yaml.d/cluster-init.yaml
    content: |
      cluster-init: true

  # Cilium validation execution (script itself is in common.yaml, available on all nodes)
  - path: /etc/systemd/system/rke2-server.service.d/post-start-master.conf
    content: |
      [Service]
      ExecStartPost=/bin/sh -xc '/usr/local/sbin/rke2-cilium-check'

  # (Envoy Gateway manifest moved to full overlay)

  # OpenEBS ZFS - MIGRATED to kpt package
  # See: kpt/catalog/storage/openebs-zfs/
  # Provides: persistent storage backed by ZFS via static manifests

  # Tailscale operator - MIGRATED to kpt package
  # See: kpt/catalog/mesh/tailscale/
  # Provides: mesh networking, subnet routing for VIP + LoadBalancer pool

  # Downstream Git repository sync helper (control-plane only)
  - path: /usr/local/sbin/rke2-cluster-repo-sync
    permissions: "0755"
    content_from_file: ${CLOUD_CONFIG_SOURCE_DIR}/scripts/rke2-cluster-repo-sync.sh
  - path: /etc/rke2-kpt-packages.yaml
    permissions: "0644"
    content: |
      # @codebase
      packages:
        - name: traefik
          target: kpt/system/traefik
          source: https://github.com/nxmatic/incus-rke2-cluster.git/kpt/system/traefik
          ref: main
        - name: cilium
          target: kpt/system/cilium
          source: https://github.com/nxmatic/incus-rke2-cluster.git/kpt/system/cilium
          ref: main
        - name: flux-operator
          target: kpt/system/flux-operator
          source: https://github.com/nxmatic/incus-rke2-cluster.git/kpt/system/flux-operator
          ref: main
        - name: tekton-pipelines
          target: kpt/system/tekton-pipelines
          source: https://github.com/nxmatic/incus-rke2-cluster.git/kpt/system/tekton-pipelines
          ref: main          
  - path: /etc/systemd/system/rke2-cluster-repo-sync.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Sync downstream cluster Git repository
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/rke2-cluster-repo-sync
      RemainAfterExit=yes
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable rke2-cluster-repo-sync.service
  - systemctl start rke2-cluster-repo-sync.service
  - /usr/local/sbin/rke2-manifests-unpack
