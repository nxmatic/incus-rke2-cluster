# incus preseed for rke2 cluster (LAN macvlan + cluster bridge) (@codebase)
#
# Architecture:
# - lan0: macvlan device on vmlan0 for PRIMARY internet access via home router
# - vmnet0: Incus-managed bridge network for inter-node cluster communication ONLY
#
# Current routing strategy (November 2025):
# - Internet: via lan0 (metric 100) → home router → reliable NAT
# - Cluster: via vmnet0 (metric 9999) → Lima VM bridge → node-to-node communication
# - Lima VM NAT disabled due to TCP reliability issues (ICMP works, TCP timeouts)
#
# Previous approach used dual macvlan for both interfaces, which prevented Lima VM from being
# reachable as a gateway due to macvlan isolation (parent cannot communicate with children).
config: {}
storage_pools:
  - name: default
    driver: zfs
    config:
      source: tank/nerd/incus
# Incus-managed bridge network for cluster node communication
# Provides inter-node connectivity within the VM cluster
# Internet access is exclusively via lan0/home router
# Cluster allocation: 10.80.(CLUSTER_ID * 8).0/21
networks:
  - name: vmnet
    type: bridge
    config:
      ipv4.address: ${CLUSTER_GATEWAY_IP}/21
      ipv4.nat: "false"         # NAT disabled - cluster-internal only
      ipv4.routing: "false"      # No routing - isolated bridge
      ipv4.dhcp: "true"
      ipv4.dhcp.ranges: ${WAN_DHCP_RANGE}
      dns.mode: none
      bridge.driver: native
      # Static DHCP leases for RKE2 nodes - ensures predictable IP allocation
      # Format: dhcp-host=MAC,IP,hostname
      # MACs use QEMU prefix 52:54:00 + cluster_id:node_type:node_id (in hex, zero-padded)
      # IPs use cluster network base + node offset (10 for master, 11-13 for peers, 20+ for workers)
      raw.dnsmasq: |
        dhcp-host=${NODE_WAN_MAC_MASTER},${CLUSTER_NODE_IP_BASE}.10,master
        dhcp-host=${NODE_WAN_MAC_PEER1},${CLUSTER_NODE_IP_BASE}.11,peer1
        dhcp-host=${NODE_WAN_MAC_PEER2},${CLUSTER_NODE_IP_BASE}.12,peer2
        dhcp-host=${NODE_WAN_MAC_PEER3},${CLUSTER_NODE_IP_BASE}.13,peer3
        dhcp-host=${NODE_WAN_MAC_WORKER1},${CLUSTER_NODE_IP_BASE}.20,worker1
        dhcp-host=${NODE_WAN_MAC_WORKER2},${CLUSTER_NODE_IP_BASE}.21,worker2
profiles:
  - name: ${NODE_PROFILE_NAME}
    description: RKE2 profile (LAN macvlan + cluster bridge)
    devices:
      root:
        path: /
        pool: default
        type: disk
      lan0:
        name: lan0
        nictype: ipvlan
        ipvlan.mode: l2
        parent: vmlan0
        type: nic
      vmnet0:
        name: vmnet0
        network: vmnet
        type: nic
