# incus preseed for rke2 cluster (LAN macvlan + WAN bridge) (@codebase)
#
# Architecture:
# - lan0: macvlan device on vmlan0 for dedicated load balancer LAN access
# - wan0: Incus-managed bridge network providing cluster networking + internet via Lima VM gateway
#
# Previous approach used dual macvlan for both interfaces, which prevented Lima VM from being
# reachable as a gateway due to macvlan isolation (parent cannot communicate with children).
#
# Current approach:
# - LAN: macvlan on vmlan0 (external DHCP from home network)
# - WAN: Incus bridge with Lima VM at .1 as gateway for cluster traffic + internet NAT
#
# This enables:
# - Lima VM reachable at 10.80.16.1 (cluster 2) as default gateway
# - Cluster nodes on same /21 network with DHCP
# - Lima VM provides routing/NAT to uplink for internet access
# - LAN access preserved for dedicated load balancers
config: {}
storage_pools:
  - name: default
    driver: zfs
    config:
      source: tank/nerd/incus
# Incus-managed bridge network for WAN (cluster network + internet gateway)
# This replaces the macvlan vmwan0 approach to allow the Lima VM to be reachable as a gateway
# The Lima VM will have IP .1 on this bridge and provide routing/NAT to uplink
# Cluster allocation: 10.80.(CLUSTER_ID * 8).0/21
networks:
  - name: wan
    type: bridge
    config:
      ipv4.address: ${CLUSTER_GATEWAY_IP}/21
      ipv4.nat: "true"
      ipv4.routing: "true"
      ipv4.dhcp: "true"
      ipv4.dhcp.gateway: ${CLUSTER_GATEWAY_IP}
      ipv4.dhcp.ranges: ${WAN_DHCP_RANGE}
      dns.mode: none
      bridge.driver: native
      # Static DHCP leases for RKE2 nodes - ensures predictable IP allocation
      # Format: dhcp-host=MAC,IP,hostname
      # MACs use QEMU prefix 52:54:00 + cluster_id:node_type:node_id (in hex, zero-padded)
      raw.dnsmasq: |
        dhcp-host=52:54:00:02:00:00,10.80.16.10,master
        dhcp-host=52:54:00:02:00:01,10.80.16.11,peer1
        dhcp-host=52:54:00:02:00:02,10.80.16.12,peer2
        dhcp-host=52:54:00:02:00:03,10.80.16.13,peer3
        dhcp-host=52:54:00:02:01:0a,10.80.16.20,worker1
        dhcp-host=52:54:00:02:01:0b,10.80.16.21,worker2
profiles:
  - name: ${NODE_PROFILE_NAME}
    description: RKE2 profile (LAN macvlan + WAN bridge)
    devices:
      root:
        path: /
        pool: default
        type: disk
      lan0:
        name: lan0
        nictype: macvlan
        parent: vmlan0
        type: nic
      wan0:
        name: wan0
        network: wan
        type: nic
        hwaddr: ${NODE_WAN_MAC}
