# Minimal distrobuilder configuration using rootfs-http without package management
# This avoids all the package management issues by using the cloud image as-is

image:
  distribution: debian
  release: trixie
  architecture: arm64
  description: >-
    K8s Master Control Node base (Debian trixie) - minimal cloud image
  expiry: 30d

source:
  downloader: rootfs-http
  url: https://cloud.debian.org/images/cloud/trixie/latest/debian-13-generic-arm64.tar.xz

# Minimal package configuration - no actual packages to install
packages:
  manager: apt
  update: false
  cleanup: false

actions:
  # Basic system configuration using simple commands
  - trigger: post-files
    action: |
      #!/bin/sh
      echo "==> Basic system setup"
      # Enable SSH if systemctl is available
      if command -v systemctl >/dev/null 2>&1; then
        systemctl enable ssh || true
      fi
      # Generate basic locale if possible
      if [ -f /usr/sbin/locale-gen ]; then
        echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen || true
        locale-gen || true
      fi
      echo "System setup complete"

files:
  - path: /etc/ssh/sshd_config.d/99-custom.conf
    generator: dump
    content: |
      # Custom SSH configuration for container
      PermitRootLogin yes
      PasswordAuthentication yes
      PubkeyAuthentication yes
  
  - path: /etc/locale.gen
    generator: dump
    content: |
      en_US.UTF-8 UTF-8