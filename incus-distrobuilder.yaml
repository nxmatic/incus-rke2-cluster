# build-packages.yaml
# Base image: system update and package installation only
image:
  distribution: debian
  release: bookworm
  architecture: arm64
  description: "K8s Master Control Node base with systemd and packages"
  expiry: 30d

source:
  downloader: debootstrap
  url: https://deb.debian.org/debian
  keys:
    - F8D2585B8783D481
  keyserver: keyserver.ubuntu.com

packages:
  manager: apt
  update: true
  cleanup: true
  repositories:
    - name: debian-bookworm-extras
      url: "deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware"
    - name: debian-bookworm-security
      url: "deb http://security.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware"
    - name: debian-bookworm-updates
      url: "deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware"
    - name: debian-unstable
      url: "deb http://deb.debian.org/debian unstable main"
  sets:
    - packages:
        - acl
        - apt-file
        - apt-transport-https
        - apt-utils
        - bash-completion
        - bc
        - binutils
        - bzip2
        - ca-certificates
        - curl
        - direnv
        - dstat
        - dnsutils
        - emacs-nox
        - file
        - git
        - gh
        - gnupg
        - gzip
        - htop
        - iproute2
        - iptables
        - iputils-ping
        - jq
        - kmod
        - less
        - lshw
        - lsof
        - man
        - man-db
        - nmap
        - net-tools
        - netcat-openbsd
        - open-iscsi
        - openssh-client
        - openssh-server
        - p7zip-full
        - procps
        - psmisc
        - pv
        - rsync
        - socat
        - strace
        - sudo
        - systemd
        - systemd-container
        - systemd-resolved
        - systemd-sysv
        - systemd-timesyncd
        - netplan.io
        - tar
        - tree
        - traceroute
        - tshark
        - uuid-runtime
        - wget
        - zsh
        - xz-utils
      action: install

actions:
  # After base package sets are installed, pin and install cloud-init from unstable (sid)
  - trigger: post-packages
    action: |
      #!/usr/bin/env bash
      set -euo pipefail
      echo "==> Creating apt pin for cloud-init from unstable"
      printf '%s\n' \
        'Package: cloud-init' \
        'Pin: release a=unstable' \
        'Pin-Priority: 990' \
        '' \
        'Package: *' \
        'Pin: release a=unstable' \
        'Pin-Priority: 50' \
        > /etc/apt/preferences.d/90-unstable-cloud-init.pref
      echo "==> Updating package indices"
      apt-get update -y
      echo "==> Installing cloud-init from unstable"
      DEBIAN_FRONTEND=noninteractive apt-get install -y -t unstable cloud-init
      echo "==> cloud-init version installed: $(cloud-init --version || true)"
  - trigger: post-files
    action: |
      #!/usr/bin/env -S bash -exu -o pipefail

      : generate locale
      cat <<EoF | tee -a /etc/locale.gen
      en_US.UTF-8 UTF-8
      EoF
      locale-gen

      : set default locale
      cat <<EoF | tee /etc/default/locale
      LANG=En_US.UTF-8
      LANGUAGE=en_US.UTF-8
      LC_ALL=en_US.UTF-8
      EoF

      : enable systemd-networkd and disable NetworkManager
      systemctl disable NetworkManager || true
      systemctl mask NetworkManager || true
      systemctl enable systemd-networkd
      systemctl enable systemd-resolved

  - trigger: post-files
    action: |
      #!/usr/bin/env -S bash -exu -o pipefail

      : Create a one-shot systemd service to mount the RKE2 root zvol
      :   incus block devices cannot be exposed as a systemd mounts

      systemctl mask zfs-load-module
      systemctl mask zfs-volume-wait.service
      systemctl mask systemd-rfkill.service

files:
  # Cloud init nocloud datasource configuration
  - name: cloud-init-nocloud
    generator: dump
    path: /etc/cloud/cloud.cfg.d/00-nocloud.cfg
    content: |
      datasource_list: [ NoCloud ]
      datasource:
        NoCloud:
          seedfrom: /var/lib/cloud/seed/nocloud/
  # Ensure systemd module is present (older cloud-init configs may omit it)
  - name: cloud-init-systemd-module
    generator: dump
    path: /etc/cloud/cloud.cfg.d/99-systemd-module.cfg
    content: |
      #cloud-config
      cloud_config_modules:
       - snap
       - ssh-import-id
       - keyboard
       - locale
       - set-passwords
       - grub-dpkg
       - apt-pipelining
       - apt-configure
       - ntp
       - timezone
       - disable-ec2-metadata
       - systemd
       - runcmd
       - byobu
