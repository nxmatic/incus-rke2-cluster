# yaml-language-server: $schema=https://raw.githubusercontent.com/canonical/netplan/main/netplan/cli/schema.json
# network-config (NoCloud datasource) (@codebase)
#
# MANDATORY SEPARATION: Modern cloud-init requires network configuration to be separated
# from user-data to prevent parsing issues. Older cloud-init versions failed silently
# when network config was embedded, causing truncated interface configuration.
#
# Use networkd renderer for systemd-networkd management (shows as "managed" in networkctl).
# Disable IPv6 on lan0 to avoid DHCPv6 client dependency issues that break ifupdown parsing.
network:
  version: 2
  renderer: networkd
  ethernets:
    # ===== LAN INTERFACE (DHCP) =====
    # Local network access without routing conflicts  
    lan0:
      # DHCP Configuration with strict overrides
      dhcp4: true
      dhcp4-overrides:
        use-routes: false      # Prevent ALL routes from DHCP
        use-dns: false         # Prevent DNS override from DHCP
        use-domains: false     # Prevent domain override from DHCP
        use-hostname: false    # Prevent hostname override
        send-hostname: false   # Don't send hostname to DHCP server
        route-metric: 9999     # Set extremely high metric as last resort
      dhcp6: false             # Disable IPv6 DHCP
      dhcp-identifier: mac

      # Interface Options
      optional: false

    # ===== WAN INTERFACE (STATIC) =====
    # Cluster network with static IP, routing, and DNS
    wan0:
      # DHCP disabled for static IP configuration
      dhcp4: false

      # Static IP Configuration
      addresses:
        - ${RKE2_NODE_HOST_IP}/24
      routes:
        - to: 0.0.0.0/0
          via: ${RKE2_NODE_GATEWAY_IP}
          metric: 100

      # DNS Configuration
      nameservers:
        addresses:
          - ${RKE2_NODE_GATEWAY_IP}     # Primary: node gateway
          - 1.1.1.1                  # Fallback: Cloudflare DNS

      # Interface Options
      optional: false

    # ===== VIP INTERFACE (SHARED) =====
    # Shared interface for VIP announcements across all control-plane nodes
    vip0:
      # DHCP disabled - VIPs managed by Cilium/kube-vip
      dhcp4: false
      dhcp6: false

      # Static IP from dedicated VIP network (each node gets a unique IP)
      addresses:
        - ${RKE2_NODE_VIP_IP}/24

      # Interface Options
      optional: false
