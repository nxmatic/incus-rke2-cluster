#!/usr/bin/env -S bash -euo pipefail

exec 2>/tmp/derive-network-setters.log
set -x

: "Locate precomputed plan (generated by make.d/network/rules.mk)"
basedir="$(dirname "$0")/../.."
netplan="${basedir}/network.yaml"
if [[ ! -f "$netplan" ]]; then
  netplan="${basedir}/rke2-subtree/network.yaml"
fi
if [[ ! -f "$netplan" ]]; then
  echo "network.yaml not found at $netplan; run make generate@network" >&2
  exit 1
fi

input=$(cat)

: "Load all setter values into environment"
set -a

: "Load setter values from existing ConfigMaps in input"
source <( yq -o shell '
  select(.kind == "ConfigMap" and 
         .metadata.annotations."internal.kpt.dev/function-config" == "apply-setters") |
  .data
' - <<< "$input" )

: "Load values from precomputed network plan"
source <( yq -o shell '.data' "$netplan")

set +a



# Load all plan data into shell vars (yq shell output keeps strings)

# Export specific plan values as strings (avoid URI/int issues)
# set -a
# VIP_CIDR=${vip_pool_cidr:-}
# LB_CIDR=${lb_pool_cidr:-}
# NODE_VIP_IP=${node_vip_ip:-}
# NODE_GATEWAY_IP=${node_gateway_ip:-}
# set +a

# input=$( yq 	eval '
#   with(.items[] | select(.kind == "ConfigMap" and .metadata.name == "kube-vip-setters");
#     .data."cluster-vip-address" = env(NODE_VIP_IP)
#   ) |
#   with(.items[] | select(.kind == "ConfigMap" and .metadata.name == "tailscale-setters");
#     .data."vip-address" = env(NODE_VIP_IP) |
#     .data."lb-pool-cidr" = env(LB_CIDR)
#   ) |
#   with(.items[] | select(.kind == "ConfigMap" and .metadata.name == "cilium-setters");
#     .data."vip-pool-cidr" = env(VIP_CIDR) |
#     .data."lb-pool-cidr" = env(LB_CIDR) |
#     .data."node-gateway-ip" = env(NODE_GATEWAY_IP)
#   )' - <<< "$input" )

# Substitute ${...} placeholders in HelmChart/HelmChartConfig valuesContent using envsubst
yq eval '
  with(.items[] | select(.kind == "HelmChart" or .kind == "HelmChartConfig");
    .spec.valuesContent |= envsubst
  )
' - <<< "$input"
