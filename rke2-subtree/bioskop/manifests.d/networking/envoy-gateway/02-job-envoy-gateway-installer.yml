---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    internal.kpt.dev/upstream-identifier: batch|Job|envoy-gateway-system|envoy-gateway-installer
    kpt.dev/package-layer: networking
    kpt.dev/package-name: envoy-gateway
  name: envoy-gateway-installer
  namespace: envoy-gateway-system
spec:
  backoffLimit: 3
  template:
    metadata:
      annotations:
        kpt.dev/package-layer: networking
        kpt.dev/package-name: envoy-gateway
    spec:
      containers:
        - command:
            - sh
            - -c
            - |
              set -e
              echo "Installing Envoy Gateway v1.4.2..." # kpt-set: Installing Envoy Gateway ${envoy-gateway-version}...
              kubectl apply \
                --server-side \
                --force-conflicts \
                -f https://github.com/envoyproxy/gateway/releases/download/v1.4.2/install.yaml # kpt-set: -f https://github.com/envoyproxy/gateway/releases/download/${envoy-gateway-version}/install.yaml

              echo "Waiting for Envoy Gateway deployment..."
              kubectl wait --timeout=300s \
                --namespace envoy-gateway-system \
                --for=condition=available \
                deployment/envoy-gateway

              echo "Envoy Gateway installation complete!"
          image: alpine/k8s:1.29.8
          name: installer
      restartPolicy: OnFailure
      serviceAccountName: envoy-gateway-installer
  ttlSecondsAfterFinished: 300
